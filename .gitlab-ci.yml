stages:
  - static analysis
  - test
  
  
# check the code adheres to the coding standards
static:
  stage: static analysis
  image: python:3.8
  allow_failure: false
  before_script:  # install this project's dependencies using the requirements.txt file
    - pip install --extra-index-url https://gitlab-ci-token:$CI_BUILD_TOKEN@gitlab.esa.int/api/v4/projects/2014/packages/pypi/simple -r requirements.txt
  script:
    - pip install black flake8 isort mypy
    - mypy --ignore-missing-imports pyoptgra/*.py
    - black --check pyoptgra/*.py
    - flake8 --max-line-length 120 pyoptgra/*.py
    - isort --check pyoptgra

test:
  stage: test
  image: python:3.8
  allow_failure: false
  before_script:  # install this project's dependencies using the requirements.txt file
    - apt update && apt install gfortran --yes
    - pip install --extra-index-url https://gitlab-ci-token:$CI_BUILD_TOKEN@gitlab.esa.int/api/v4/projects/2014/packages/pypi/simple -r requirements.txt
  script:
    - python setup.py install --user
    - pip install pytest-cov coverage
    - cd tests # move into test directory to ensure that the installed package is tested, not the source
    - pytest --cov pyoptgra --cov-report term-missing test.py
    - coverage report --fail-under=99

